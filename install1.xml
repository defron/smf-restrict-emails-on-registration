<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<name>Restrict Email Providers on Registration</name>
<id>Duncan85:Restrict_Email_Providers_on_Registration</id>
<version>1.2</version>

<file name="$sourcedir/Subs-Members.php">
<operation>
	<search position="replace"><![CDATA[	// !!! Separate the sprintf?
	if (empty($regOptions['email']) || preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', stripslashes($regOptions['email'])) === 0 || strlen(stripslashes($regOptions['email'])) > 255)
		fatal_error(sprintf($txt[500], $regOptions['username']), false);]]></search>
	<add><![CDATA[   // Lets restrict some email providers
   if (!empty($modSettings['restricted_provider']))
   {
      $restricted_provider = explode(",", preg_replace("/(\@[^a-zA-Z0-9,])/", "", $modSettings['restricted_provider']));

      foreach ($restricted_provider as $key => $value)
         if (empty($value))
            unset($restricted_provider[$key]);
   }
   else
      $restricted_provider = array();
	  

   if (!empty($modSettings['enable_restrict_EmailProvider']) && !empty($modSettings['restricted_provider']))
   {
      foreach($restricted_provider as $provider)
      {         
         preg_match('/' . $provider . '+/i', $_POST['email'], $matches);
   
         if(count($matches) > 0)
            fatal_error(sprintf($txt['restricted'], $regOptions['username']), false);
      }
   }
   
   	if (!empty($modSettings['accepted_provider']))
   {
      $accepted_provider = explode(",", preg_replace("/(\@[^a-zA-Z0-9,])/", "", $modSettings['accepted_provider']));

      foreach ($accepted_provider as $akey => $avalue)
         if (empty($avalue))
            unset($accepted_provider[$akey]);
   }
   else
      $accepted_provider = array();  
   
    if (!empty($modSettings['enable_restrict_EmailProvider']) && !empty($modSettings['accepted_provider']))
   {
      foreach($accepted_provider as $aprovider)
      {         
         preg_match('/' . $aprovider . '+/i', $_POST['email'], $matches);
		 
		if(count($accepted_provider) == 1)
		{
			if(count($matches) == 0)
				fatal_error(sprintf($txt['restricted'], $regOptions['username']), false);
		}
		else
		{
			if(count($matches) == 0 && !(each($accepted_provider)))
				fatal_error(sprintf($txt['restricted'], $regOptions['username']), false);
		}	
      }
   }
   // !!! Separate the sprintf?

   elseif (empty($regOptions['email']) || preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', stripslashes($regOptions['email'])) === 0 || strlen(stripslashes($regOptions['email'])) > 255)
		fatal_error(sprintf($txt[500], $regOptions['username']), false);]]></add>
	</operation>
	
</file>

<file name="$sourcedir/ModSettings.php">
<operation>
	<search position="replace"><![CDATA[			array('check', 'allow_guestAccess'),]]></search>
	<add><![CDATA[			array('check', 'allow_guestAccess'),
			'',
			array('check', 'enable_restrict_EmailProvider',
			&$txt['enable_restrict_EmailProvider']), 
			array('text', 'restricted_provider', '35', 
			&$txt['restricted_provider']),
			array('text', 'accepted_provider', '35', 
			&$txt['accepted_provider']),
			'',
]]></add>
	</operation>

</file>


<file name="$languagedir/Modifications.english.php">
	<operation>
	<search position="end" />
	<add><![CDATA[$txt['restricted'] = 'Sorry, E-mail accounts from that provider cannot be used, we have had members reporting emails not being received when using the E-Mail addresses from your provider,please use an alternative email address.We are sorry for the inconvenience caused by your E-Mail provider.';
$txt['enable_restrict_EmailProvider'] = 'Enable restriction of E-Mail providers <br />on registration';
$txt['restricted_provider'] = 'Which providers should be restricted <br />on registration ? <br /><i> (As an example,for the providers <b><font color="red">hotmail and gmail</font></b> you should write @hotmail.com,@gmail.com) ';
$txt['accepted_provider'] = 'Which providers should be accepted <br />on registration ? <br /><i> (As an example,for the providers <b><font color="red">hotmail and gmail</font></b> you should write @hotmail.com,@gmail.com).<font color="red"><b>Note that either restricted provider or accepted provider list should be empty </b></font>';
]]></add>
	</operation>
</file>

<file name="$languagedir/Modifications.english-utf8.php" error="skip">
	<operation>
	<search position="end" />
	<add><![CDATA[$txt['restricted'] = 'Sorry, E-mail accounts from that provider cannot be used, we have had members reporting emails not being received when using the E-Mail addresses from your provider,please use an alternative email address.We are sorry for the inconvenience caused by your E-Mail provider.';
$txt['enable_restrict_EmailProvider'] = 'Enable restriction of E-Mail providers <br />on registration';
$txt['restricted_provider'] = 'Which providers should be restricted <br />on registration ? <br /><i> (As an example,for the providers <b><font color="red">hotmail and gmail</font></b> you should write @hotmail.com,@gmail.com) ';
$txt['accepted_provider'] = 'Which providers should be accepted <br />on registration ? <br /><i> (As an example,for the providers <b><font color="red">hotmail and gmail</font></b> you should write @hotmail.com,@gmail.com).<font color="red"><b>Note that either restricted provider or accepted provider list should be empty </b></font>';
]]></add>
	</operation>
</file>


</modification>
